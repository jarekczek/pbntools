apply plugin: 'java'

repositories {
  mavenCentral()
}

configurations.create('ivy') // old configuration used by ant

dependencies {
  ivy 'junit:junit-dep:4.11'
  ivy 'junit-addons:junit-addons:1.4'
  compile 'org.jsoup:jsoup:1.7.3'
  compile 'javazoom:jlayer:1.0.1'
  testCompile 'junit:junit-dep:4.11'
  testCompile 'junit-addons:junit-addons:1.4'
}

ant.importBuild "build.xml"
ant.references['ivy.path'] = ant.path(path: configurations.ivy.files.join(';'))

tasks.clean.dependsOn 'ant-clean'
tasks.comp.dependsOn 'compileJava'
tasks['ant-jar'].dependsOn 'jar'
tasks.junit.dependsOn 'junit-local'
tasks.junit.dependsOn 'junit-www'
tasks.release.dependsOn 'fillLibDir'

sourceSets.main.java.srcDir 'src'
sourceSets.main.resources.srcDir 'resource'
sourceSets.test.java.srcDir 'junit-tests'

println project.jar

jar {
  baseName = 'PbnTools'
  manifest {
    attributes(
      "Manifest-Version": "1.0",
      "Main-Class": "jc.pbntools.PbnTools",
      "Class-Path": configurations.compile.files.collect {
        it.getName()
      }.join(" ")
    )
  }
}

task 'junit-local' (type: Test) {
  filter {
    includeTestsMatching 'jc.fTests'
    includeTestsMatching 'jc.SoupProxyTests'
    includeTestsMatching 'jc.pbntools.PbnToolsTests'
  }
}

task 'junit-www' (type: Test) {
  doFirst {
    println 'junit-www tests, prerequisites:'
    println '1. serve test/*www* directories at http://localhost/pbntools'
    println '   (use install_www_tests.sh)'
    println '2. turn off internet (suggestion only)'
  }
  //TODO <junitpreset timeout="20000" >
  filter {
    includeTestsMatching 'jc.pbntools.PbnToolsWwwTests'
  }
}

tasks.withType(Test) {
  outputs.upToDateWhen {false}
  testLogging.showStandardStreams = true
  testLogging.exceptionFormat = 'full'
}

task run(type: JavaExec) {
  classpath = sourceSets.main.runtimeClasspath
  main = 'jc.pbntools.PbnTools'
  jvmArgs "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=7779"
}

task fillLibDir(type: Copy, dependsOn: ['fillLibDir2', 'fillLibDir3']) {
  from configurations.compile.files
  into 'lib'
}

task fillLibDir2(type: Copy) {
  from 'release_files'
  exclude 'doc'
  into 'lib'
}

task fillLibDir3(type: Copy) {
  from 'release_files/doc'
  into 'doc'
}
